## 项目介绍

### 技术栈：

`Spring Boot`+`Docker`+`Mybatis`+`Spring Cloud`+ `RabbitMq`+`MySQL`

### 版本：

微服务版本（此仓库为微服务版本），单体版本请到[这里](https://github.com/fanshuaiyao/OJ-backend)

### 实现功能：

* 系统可以根据管理员预设的题目用例对用户提交的代码进行执行和评测，系统中自主实现的代码沙箱作为独立服务可供其他人员调用

* 管理员可以进行增删改查题目

* 用户可以进行查看题目、提交代码、搜索题目

### 系统模块

* 题目模块
  * 创建题目
  * 删除题目
  * 修改题目
  * 搜索题目
  * 在线做题
  * 提交代码
* 用户模块
  * 登录
  * 注册
* 判题模块
  * 提交
  * 错误处理
  * 代码沙箱
  * 开放接口
 
### 主要工作

1. 自主设计判题机模块的架构，定义了代码沙箱的抽象调用接口和多种实现类（示例/远程），并通过静态工厂模式 + Spring 配置化的方式实现了对多种代码沙箱的灵活调用。使用代理模式对代码沙箱接口进行日志增强。选用策略模式独立封装了多种不同的判题策略，提高系统的可维护性。
2. 在代码沙箱中使用 Java Runtime 对象的 exec 方法实现了对 Java 程序的编译和执行，并通过 Process 类的输入流获取执行结果，实现了 Java 原生代码沙箱。模拟了多种程序异常情况并有针对性解决，如使用守护线程 + Thread.sleep 等待机制实现了对进程的超时中断、使用 JVM -Xmx 参数限制用户程序占用的最大堆内存，使用 Java 安全管理器和自定义的 Security Manager 对用户提交的代码进行权限控制。
3. 为保证沙箱宿主机的稳定性，选用 Docker 隔离用户代码，使用 Docker Java 库创建容器隔离执行代码，为提高 安全性，通过 HostConfig 限制了容器的内存限制和网络隔离，并通过设置容器执行超时时间解决资源未及时释放的问题。并使用模板方法为两种沙箱定义了一套标准流程，简化代码。为防止用户恶意请求代码沙箱服务，通过约定字符串密钥，保证调用安全。

4. 使用Spring Cloud Alibaba重构单体项目，使用Redis分布式Session存储登录用户信息，梳理各个服务之间的调用关系，并通过Nacos+OpenFeign实现了各模块之间的相互调用。使用Spring Cloud Gateway对各服务接口进行聚合和路由，并通过自定义CorsWebFilter Bean全局解决了跨域问题。使用Knife4j Gateway在网关层实现了对各服务Swagger接口文档的统一聚合。为保护内部服务接口，给接口路径统一设置inner前缀，并通过在网关自定义GlobalFilter实现对内部请求的检测和拦截，集中解决了权限校验问题。

5. 为防止判题操作执行时间较长，系统选用异步的方式，在题目服务中将用户提交id发送给RabbitMQ消息队列，并通过Direct交换机转发给判题队列，由判题服务进行消费，异步更新提交状态。相比于同步，响应时长由xx秒减少至xx秒，且系统qps提升了xxx%（需要自己使用JMeter等工具进行测试）。

### 系统时序图
![image-20241206161334303](https://shuaiyao85.oss-cn-qingdao.aliyuncs.com/img/202412061613365.png)
### TODO
- [ ] 前端美化
- [ ] 第三方代码沙箱调用
- [ ] 接入AI
- [ ] 消息队列-死信队列
